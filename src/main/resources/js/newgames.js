'use strict';

var app = angular.module('newgames', ['ngSanitize', 'ui.select']);

function NewGamesCtrl($scope, $http, $timeout, $interval) {
    var vm = this;
    vm.loadGeeks = function() {
        var httpRequest = $http({
            method: 'GET',
            url: '/json/geeks'
        }).success(function(data, status) {
            vm.geeks = data["geeks"];
            vm.players = [];
        });
    };
    vm.getPlayers = function() {
        if (typeof vm.players == "undefined") return [];
        return vm.players;
    };
    vm.dataURL = function() {
        var players = vm.getPlayers();
        if (players.length == 0) return null;
        return '/json/newgames/2005/' + players.join();
    };

    vm.loadData = function() {
        var url = vm.dataURL();
        if (url == null) return;

        $.ajax({
            dataType:'json',
            url: url,
            data: { format: 'json'},
            success: function(data) {
                $(function () {
                    var myChart = Highcharts.chart('graph', {
                        chart: { type: 'scatter' },
                        title: { text: 'Plays of New Games' },
                        series: [ {"name": "Friendless", "data": [[1481806801000,363400],[1481807401000,255090],[1481808001000,204680],[1481808601000,201990],[1481809201000,249710],[1481809801000,298390],[1481810401000,315480],[1481811001000,231620],[1481811601000,333100],[1481812201000,408450],[1481812801000,511430],[1481813401000,508380],[1481814001000,505350],[1481814601000,514340],[1481815201000,515340],[1481815801000,513010],[1481816401000,473010],[1481817001000,440500],[1481817601000,402700],[1481818201000,304120],[1481818801000,142280],[1481819401000,415040],[1481820001000,165270],[1481820601000,446510],[1481821201000,347710],[1481821801000,449310],[1481822401000,270110],[1481823001000,422710],[1481823601000,289800],[1481824201000,278620],[1481824801000,315420],[1481825401000,274270],[1481826001000,234390],[1481826601000,327950],[1481827201000,306480],[1481827801000,424350],[1481828401000,311410],[1481829001000,289790],[1481829601000,184670],[1481830201000,298030],[1481830802000,171280],[1481831401000,330940],[1481832002000,191570],[1481832601000,379260],[1481833201000,205840],[1481833801000,364820],[1481834401000,462510],[1481835001000,461450],[1481835601000,437260],[1481836201000,503400],[1481836801000,446980],[1481837401000,450790],[1481838001000,483090],[1481838601000,489800],[1481839201000,511010],[1481839801000,447580],[1481840401000,410300],[1481841001000,501020],[1481841601000,524050],[1481842201000,468040],[1481842801000,517130],[1481843401000,510220],[1481844002000,409770],[1481844601000,500550],[1481845202000,513390],[1481845801000,473120],[1481846401000,381610],[1481847001000,482640],[1481847601000,515349],[1481848201000,503940],[1481848801000,509840],[1481849401000,510660],[1481850001000,504800],[1481850601000,506000],[1481851201000,516229],[1481851801000,521340],[1481852401000,506410],[1481853001000,475240],[1481853601000,515200],[1481854201000,506140],[1481854801000,524010],[1481855401000,506170],[1481856001000,502180],[1481856601000,452510],[1481857201000,493010],[1481857801000,518229],[1481858401000,514180],[1481859001000,518800],[1481859601000,513969],[1481860201000,519099],[1481860801000,511110],[1481861401000,523520],[1481862001000,523400],[1481862601000,521409],[1481863201000,524150],[1481863801000,511970],[1481864401000,509540],[1481865001000,508590],[1481865601000,505660],[1481866201000,520140],[1481866801000,503200],[1481867401000,518500],[1481868001000,522659],[1481868601000,523800],[1481869201000,509930],[1481869801000,510330],[1481870401000,515140],[1481871001000,519229],[1481871601000,519590],[1481872201000,519219],[1481872801000,511110],[1481873401000,517469],[1481874001000,491420],[1481874601000,521909],[1481875201000,517080],[1481875801000,506790],[1481876401000,510670],[1481877001000,522120],[1481877601000,513800],[1481878201000,517349],[1481878801000,519070],[1481879401000,521760],[1481880001000,524190],[1481880601000,519570],[1481881201000,517289],[1481881801000,519530],[1481882401000,515900],[1481883001000,520020],[1481883601000,512419],[1481884201000,510040],[1481884801000,506990],[1481885401000,523729],[1481886002000,513229],[1481886601000,504250],[1481887201000,515010],[1481887801000,510430],[1481888401000,521940],[1481889001000,517690],[1481889601000,513760],[1481890201000,511750],[1481890801000,521900],[1481891401000,519060],[1481892001000,514070],[1481892601000,511920],[1481893201000,512640],[1481893801000,519979],[1481894401000,516560],[1481895001000,510910],[1481895601000,521890],[1481896201000,516570],[1481896801000,521520],[1481897401000,507290],[1481898001000,509780],[1481898601000,501970]]} ],
                        xAxis: { type: 'datetime', title: { text: "Start Time"} }
                    });
                });
            },
            type: 'GET'
        });
    };

    vm.loadGeeks();
    vm.loadData();

    $scope.$watch(
        function() { return vm.players; },

        function(newValue, oldValue) {
            if (typeof newValue == "undefined") return;
            vm.numPlayers = newValue.length;
            vm.loadData();
        }
    );    
}

app.controller('NewGamesCtrl', NewGamesCtrl);